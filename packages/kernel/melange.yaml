package:
  name: kernel
  version: 6.15.6
  epoch: 1
  description: The Linux kernel
  target-architecture:
    - x86_64
  copyright:
    - license: GPL-2.0
  dependencies:
    runtime:
      - kernel-core
      - kernel-modules
      # - kernel-initramfs

environment:
  contents:
    keyring:
      - https://packages.wolfi.dev/os/wolfi-signing.rsa.pub
      - /work/melange.rsa.pub
    repositories:
      - https://packages.wolfi.dev/os
      - /work/output/packages
    packages:
      - bison
      - flex
      - busybox
      - build-base
      - binutils-dev
      - wolfi-baselayout
      - llvm
      - libelf
      - elfutils
      - elfutils-dev
      - openssl-dev
      - findutils
      - diffutils
      - perl
      - kmod
      - rsync
      - gawk
      - gnutar
      - openssl

pipeline:
  - uses: git-checkout
    with:
      repository: https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
      tag: v${{package.version}}
      expected-commit: 1562d948232546cfad45a1beddc70fe0c7b34950

  - uses: autoconf/make
    with:
      opts: prepare

  - uses: autoconf/make
    with:
      opts: modules_prepare

  - uses: autoconf/make

subpackages:
  - name: kernel-core
    description: The Linux kernel core
    pipeline:
      - runs: |
          mkdir -p ${{targets.subpkgdir}}/usr/lib/${{package.version}}
          cp ./arch/${{build.arch}}/boot/bzImage ${{targets.subpkgdir}}/usr/lib/${{package.version}}/vmlinuz
          cp System.map ${{targets.subpkgdir}}/usr/lib/${{package.version}}/System.map
          cp .config ${{targets.subpkgdir}}/usr/lib/${{package.version}}/config

  - name: kernel-modules
    description: Kernel modules for Linux
    dependencies:
      runtime:
        - kernel-core
    pipeline:
      - uses: autoconf/make-install
        with:
          opts: modules_install INSTALL_MOD_PATH=${{targets.subpkgdir}}/usr

  - name: kernel-headers
    description: Kernel headers
    dependencies:
      runtime:
        - kernel-core
    pipeline:
      - uses: autoconf/make-install
        with:
          opts: headers_install INSTALL_HDR_PATH=${{targets.subpkgdir}}

  # - name: kernel-initramfs
  #   description: Initramfs image for the kernel
  #   dependencies:
  #     runtime:
  #       - kernel-core
  #       - kernel-modules
  #       - dracut
  #       - kmod
  #       - zstd
  #   scriptlets:
  #     post-install: |
  #       #!/bin/sh
  #       depmod ${{package.version}}
  #       dracut --force --no-hostonly --reproducible --zstd --verbose --kver ${{package.version}} /usr/lib/modules/${{package.version}}/initramfs.img
