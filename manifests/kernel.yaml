package:
  name: kernel
  version: 6.15.6
  epoch: 2
  description: The Linux kernel
  copyright:
    - license: GPL-2.0

environment:
  contents:
    packages:
      - binutils-dev
      - bison
      - build-base
      - busybox
      - diffutils
      - elfutils
      - elfutils-dev
      - findutils
      - flex
      - gawk
      - gnutar
      - kmod
      - libelf
      - llvm
      - openssl
      - xz
      - zstd

pipeline:
  - uses: git-checkout
    with:
      repository: https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
      tag: v${{package.version}}
      expected-commit: 1562d948232546cfad45a1beddc70fe0c7b34950

  - if: ${{build.arch}} == 'x86_64'
    uses: fetch
    with:
      uri: https://gitlab.com/CentOS/Hyperscale/rpms/kernel/-/raw/c10s-hsk/kernel-x86_64-fedora.config?ref_type=heads
      expected-sha256: c6143d23b99929aaf8d3634d42ef83420e03453340a8a697f7f2c8f2e885891f
      extract: false

  - if: ${{build.arch}} == 'aarch64'
    uses: fetch
    with:
      uri: https://gitlab.com/CentOS/Hyperscale/rpms/kernel/-/raw/c10s-hsk/kernel-aarch64-fedora.config?ref_type=heads
      expected-sha256: 1b4a5e2cfab510f6dfdde603764eaaa1de993c50fb0deccf662b9847d3876c03
      extract: false

  - runs: mv kernel-${{build.arch}}-fedora.config* .config

  - uses: autoconf/make
    with:
      opts: prepare

  - uses: autoconf/make
    with:
      opts: modules_prepare

  - uses: autoconf/make

  - uses: autoconf/make
    environment:
      INSTALL_HDR_PATH: ${{targets.destdir}}
    with:
      opts: headers_install

  - runs: |
      install -Dpm0644 ./arch/${{build.arch}}/boot/bzImage "${{targets.destdir}}/usr/lib/modules/${{package.version}}/vmlinuz"
      install -Dpm0644 .config ${{targets.destdir}}/usr/lib/modules/${{package.version}}/config
      install -Dpm0644 -t "${{targets.destdir}}/usr/lib/modules/${{package.version}}/" ./System.map

subpackages:
  - name: kernel-modules
    description: Kernel modules
    pipeline:
      - uses: autoconf/make
        environment:
          INSTALL_MOD_PATH: ${{targets.subpkgdir}}/usr
        with:
          opts: modules_install
      - runs: |
          echo "Compressing kernel modules with xz..."
          find ${{targets.subpkgdir}}/usr/lib/modules/ -type f -name '*.ko' -print0 | xargs -0 -n1 -P$(nproc) xz -T1 --check=crc32 --lzma2=dict=1MiB
    test:
      pipeline:
        - runs: |
            stat "/usr/lib/modules/${{package.version}}" | grep -F -e "0755"
            test -d "/usr/lib/modules/${{package.version}}"
            if find /usr/lib/modules/${{package.version}} -type f -name '*.ko' | grep -q .; then
              print "%s" "Found uncompressed kernel object files" >&2
              exit 1
            fi

  - name: kernel-dev
    description: Kernel headers
    pipeline:
      - uses: split/dev
    test:
      pipeline:
        - uses: test/tw/ldd-check

update:
  enabled: true
  ignore-regex-patterns:
    - ".*-rc.*"
  release-monitor:
    identifier: 358810
